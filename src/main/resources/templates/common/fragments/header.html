<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:fragment="headerFragment">
<head>
   <script sec:authorize="isAuthenticated()">
      document.addEventListener('DOMContentLoaded', async (event) => {
         const userId = document.getElementById('userId').value;

         try {
            // 초기 알림 가져오기
            const response = await fetch(`/api/notifications/list`);
            if (!response.ok) {
               throw new Error('Network response was not ok');
            }

            // 응답이 비어 있는지 확인
            const text = await response.text();
            if (!text) {
               console.warn('Empty response received from the server.');
               updateNotificationIcon(false);
               return; // 빈 응답일 경우 함수를 종료하여 이후 코드가 실행되지 않도록 함
            }

            // JSON 파싱
            const notifications = JSON.parse(text);

            if (notifications && Array.isArray(notifications) && notifications.length > 0) {
               notifications.forEach(notification => addNotification(notification));

               // 초기 알림 아이콘 상태 설정
               const hasUnread = notifications.some(notification => notification.isRead === 'N');
               updateNotificationIcon(hasUnread);
            } else {
               console.log('No notifications found.');
               updateNotificationIcon(false); // 알림이 없으면 아이콘을 업데이트하지 않음
            }

            const eventSource = new EventSource('/api/notifications');

            eventSource.addEventListener('notification', function(event) {
               const notification = JSON.parse(event.data);
               addNotification(notification);
               updateNotificationIcon(true);
            });

            eventSource.onerror = function(event) {
               console.error("EventSource failed:", event);
            };
         } catch (error) {
            console.error('Error fetching notifications:', error);
         }

         function addNotification(notification) {
            const notificationList = document.querySelector('.notification-list');
            const newNotification = document.createElement('li');
            newNotification.innerHTML = `
                <div>
                    <span style="font-size: 10px;">${notification.message}</span>
                    <input type="hidden" value="${notification.fcId}" />
                    <input type="hidden" value="${notification.userId}" />
                </div>
            `;

            // 가장 위에 새로운 알림 추가
            notificationList.insertBefore(newNotification, notificationList.firstChild);

            // 알림이 5개를 초과하면 가장 오래된 알림 제거
            if (notificationList.childElementCount > 5) {
               notificationList.removeChild(notificationList.lastChild);
            }
         }

         function updateNotificationIcon(hasUnread) {
            const notificationIcon = document.querySelector('.ui-icon-notice');
            if (hasUnread) {
               notificationIcon.classList.add('has-unread');
            } else {
               notificationIcon.classList.remove('has-unread');
            }
         }

         // 알림 버튼 클릭 시 알림 목록 표시
         document.querySelector('.ui-icon-notice').addEventListener('click', () => {
            const notificationList = document.querySelector('.notification-list');
            notificationList.style.display = notificationList.style.display === 'block' ? 'none' : 'block';
         });

         // 알림 버튼 hover 시 has-unread 클래스 제거 및 알림 상태 업데이트
         const notificationIcon = document.querySelector('.ui-icon-notice');
         notificationIcon.addEventListener('mouseover', async () => {
            if (notificationIcon.classList.contains('has-unread')) {
               notificationIcon.classList.remove('has-unread');
               // 알림 상태 업데이트 API 호출
               try {
                  console.log(userId);

                  const response = await fetch(`/api/notifications`, {
                     method: 'PUT'
                  });

                  if (!response.ok) {
                     throw new Error('Network response was not ok');
                  }
                  console.log('Notification status updated successfully.');
               } catch (error) {
                  console.error('Error updating notification status:', error);
               }
            }
         });
      });
   </script>
   <style>
      .ui-icon-notice {
         position: relative;
         cursor: pointer;
      }
      .ui-icon-notice::after {
         content: '';
         position: absolute;
         top: 0;
         right: 0;
         width: 10px;
         height: 10px;
         border-radius: 50%;
         background-color: gray; /* 기본 회색 */
      }
      .ui-icon-notice.has-unread::after {
         background-color: red; /* 안 읽은 알림이 있을 경우 빨간색 */
      }
      .dropdown-content .notification-list {
         display: none;
         position: absolute;
         background-color: #0d47a1;
         min-width: 300px;
         box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
         z-index: 1;
         list-style-type: none;
         padding: 0;
         margin: 0;
      }
      .notification-list li {
         padding: 10px;
         border-bottom: 1px solid #ddd;
         min-width: 300px;
      }
      .notification-list li div {
         color: white;
      }
   </style>
</head>
<div class="navbar">
   <div class="top-title">FundingFlex 공식 홈페이지입니다.</div>

   <div class="auth-buttons">
   	  <div sec:authorize="isAuthenticated()" th:text="${#authentication.principal.nickname + '님 환영합니다'}"></div>
      <button sec:authorize="isAnonymous()" class="login-btn" th:attr="onclick='location.href=\'/api/login\''">로그인</button>
      <button sec:authorize="isAuthenticated()" class="login-btn" th:attr="onclick='location.href=\'/api/logout\''">로그아웃</button>
      <button sec:authorize="isAnonymous()" class="signup-btn" th:attr="onclick='location.href=\'/api/signup\''">회원 가입</button>
	  <button sec:authorize="isAuthenticated()" class="signup-btn" th:attr="onclick='location.href=\'/api/mypage\''">마이페이지</button>      <!-- <button class="#">고객센터</button> -->
      <div class="dropdown">
          <button class="support-btn" th:attr="onclick='location.href=\'/qa\''">고객센터</button>
          <ul class="dropdown-content">
              <li><a href="/qa/fqa">FAQ</a></li>
              <li><a href="/qa/myquestions">문의</a></li>
              <li><a href="/qa/chat">1 : 1 상담</a></li>
          </ul>
      </div>
      <!-- 알림 -->
      <div class="dropdown">
         <button sec:authorize="isAuthenticated()" class="ui-icon-notice">알림</button>
         <ul class="dropdown-content notification-list">
            <!-- 알림이 여기 추가됩니다 -->
         </ul>
      </div>
   </div>
</div>

<header>
   <div class="header">
      <div class="logo">
         <a th:href="@{/api/home}">
             <img th:src="@{/img/fundingflexLogo.png}" alt="FundingFlex Logo">
         </a>
      </div>
      <nav>

         <ul class="nav-links">
            <li><a href="/api/categories/1">테크/가전</a></li>
            <li><a href="/api/categories/2">뷰티</a></li>
            <li><a href="/api/categories/3">홈/리빙</a></li>
            <li><a href="/api/categories/4">푸드</a></li>
            <li><a href="/api/categories/5">반려동물</a></li>
         </ul>
      </nav>

      <div class="search">
         <input type="text" placeholder="Search">
         <button type="submit" class="btn custom-btn-shadow shadow">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                   fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
               <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
            </svg>
         </button>
      </div>

      <div class="create-funding">
         <button class="btn custom-btn-shadow shadow" th:attr="onclick='location.href=\'/api/fundings\''">펀딩 개설</button>
      </div>

   </div>
</header>
<!-- Hidden Inputs -->
<input type="hidden" id="fundingId" th:value="${fundingId}">
<input type="hidden" id="categoryId" th:value="${categoryId}">
<input type="hidden" id="userId" th:value="${loginUserId}">
</html>