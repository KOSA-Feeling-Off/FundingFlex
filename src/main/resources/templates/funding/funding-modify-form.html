<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://java.sun.com/JSP/Page"
      layout:decorate="~{common/layouts/layout}" lang="ko">
<head>
  <script>
    function validateAndSubmitForm() {
      const isValid = validateForm();
      if (isValid) {
        handleSubmit();
      }
      return false; // Prevent default form submission
    }

    async function handleSubmit() {
      const form = document.getElementById('fundingsForm');
      const formData = new FormData(form);

      const imageUploads = document.querySelectorAll('#imageUploadContainer .image-upload');
      let imageArray = [];

      for (const imageUpload of imageUploads) {
        const order = parseInt(imageUpload.id.replace('image-upload-', ''));
        const hiddenInput = imageUpload.querySelector('input[name="existingImages"]');
        const imgTag = imageUpload.querySelector('img.uploaded-image');
        const fileInput = imageUpload.querySelector('input[type="file"][name="images"]');
        let type = 'new';
        let url = '';
        let filename = '';
        let base64 = '';

        if (hiddenInput) {
          type = 'existing';

          // 정규식
          const regex = /http:\/\/(www\.)?localhost\/images\/fundings\//g;

          const imgSrcWithoutPath = imgTag.src.replace(regex, '').replace(/\s|%/g, '');
          const hiddenValueClean = hiddenInput.value.replace(/\s|%/g, '');

          // 파일 이름의 UUID 부분만 비교
          const imgUUID = imgSrcWithoutPath.split('_')[0];
          const hiddenUUID = hiddenValueClean.split('_')[0];

          console.log(imgUUID);
          console.log(hiddenUUID);

          if (imgUUID === hiddenUUID) {
            url = imgTag.src.replace(regex, '');
          } else if (imgTag.src.startsWith('data')) {
            url = '';
            filename = fileInput.files[0].name;  // 수정된 부분
            base64 = imgTag.src;
          }

        } else if (fileInput && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          base64 = await toBase64(file);
          filename = file.name;
          url = '';
        }

        // type이 'new'이고 filename이 없다면 push 하지 않음
        if (!(type === 'new' && !filename)) {
          imageArray.push({
            type: type,
            url: url,
            filename: filename,
            base64: base64,
            order: order
          });
        }
      }

      formData.append('imageArray', JSON.stringify(imageArray));

      fetch(form.action, {
        method: form.method,
        body: formData
      }).then(response => {
        if (response.ok) {
          window.location.href = response.url;
        } else {
          console.error('Form submission failed.');
        }
      });
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
  </script>
</head>
<div layout:fragment="content" class="content">
    <div class="container-body">
        <div class="text-body">
        	<div class="form-make-body col-md-7">

             <h2 class="text-center my-4">펀딩 수정</h2>

            <form id="fundingsForm"
                  th:data-fundings-id="${fundingsInfo.fundingsId}"
                  th:action="@{/api/fundings/{categoryId}/{fundingsId}(categoryId=${fundingsInfo.categoryId}, fundingsId=${fundingsInfo.fundingsId})}"
                  th:object="${fundingsInfo}" method="post" enctype="multipart/form-data" onsubmit="return validateAndSubmitForm()">

                <!-- 카테고리 -->
                <div class="form-group mt-4">
                  <label for="category">카테고리</label>
                  <select id="category" th:field="*{categoryId}" class="form-control" onchange="updateCategoryName()" disabled>
                    <option value="">카테고리를 선택하세요</option>
                    <option th:each="category : ${categoryList}"
                            th:value="${category.categoryId}"
                            th:text="${category.categoryName}"
                            th:selected="${category.categoryId == fundingsInfo.categoryId}">
                    </option>
                  </select>
                  <div id="categoryError" class="text-danger mt-1" style="display: none;">카테고리를 선택해주세요</div>
                </div>

                  <div class="form-group mt-4">
                    <label for="title">제목</label>
                    <input type="text" id="title" th:field="*{title}" placeholder="제목을 입력해주세요" class="form-control"/>
                    <div id="titleError" class="text-danger mt-1" style="display: none;">제목을 입력해주세요</div>
                  </div>

                  <div class="form-group mt-4">
                    <label for="content">내용</label>
                    <textarea id="content" th:field="*{content}" placeholder="내용을 입력해주세요"
                              class="form-control textarea-large"></textarea>
                    <div id="contentError" class="text-danger mt-1" style="display: none;">내용을 입력해주세요</div>
                  </div>

                  <div class="form-group mt-4">
                    <label for="goalAmount">목표 금액 설정</label>
                    <input type="number" id="goalAmount" th:field="*{goalAmount}" class="form-control" min="5000" step="5000"/>
                    <div id="amountError" class="text-danger mt-1" style="display: none;">목표 금액을 입력해주세요</div>
                  </div>

              <!-- 이미지 업로드 5개의 네모 칸 -->
              <div class="form-group mt-5">
                <label>이미지 업로드</label>
                <div id="imageUploadContainer" class="image-upload-container">
                  <div th:each="image, iterStat : ${imageList}">
                    <div class="image-upload">
                        <input type="hidden" name="existingImages" th:value="${image.imageUrl}" th:data-order="${iterStat.index}"/>
                        <input type="file" name="images" accept="image/*" onchange="previewImage(this)">
                        <img th:src="@{/images/fundings/{imageUrl}(imageUrl=${image.imageUrl})}" class="uploaded-image" alt="fundingsImages"
                             style="display: block; height: auto"/>
                    </div>
                  </div>
                  <!-- 빈 이미지 업로드 칸 추가 -->
                  <div th:if="${#lists.size(imageList) < 5}" th:each="i : ${#numbers.sequence(#lists.size(imageList), 4)}">
                    <div class="image-upload">
                      <input type="file" name="images" accept="image/*" onchange="previewImage(this)">
                      <img src="#" class="uploaded-image" style="display: none;">
                    </div>
                  </div>
                </div>
              </div>

                 <div class="form-group text-center mt-4">
                     <button type="submit" class="btn btn-primary">수정</button>
                 </div>

           		</form>
            </div>

        </div>
    </div>
</div>

</html>
