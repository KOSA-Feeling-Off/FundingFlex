<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://java.sun.com/JSP/Page" layout:decorate="~{common/layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>메인 페이지</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/mainpage.css}">
    <script>
	async function fetchFundings(sortBy = 'createdDate') {
    try {
        	const response = await fetch(`/api/fundings/list?sortBy=${sortBy}`); // userId를 실제 값으로 변경해야 합니다.
        	if (!response.ok) {
            	throw new Error(`HTTP error! status: ${response.status}`);
        	}
        	const fundingsList = await response.json();
        	displayFundings(fundingsList.slice(0, 8), sortBy); // 최대 8개까지 자르기
    	} catch (error) {
        	console.error('Error:', error);
        	alert(`펀딩 목록을 가져오는 중 오류가 발생했습니다: ${error.message}`);
   		}
	}

function displayFundings(fundingsList, sortBy) {
    console.log(fundingsList); // 전달된 데이터 확인
    const fundingsContainer = document.getElementById(`${sortBy}Container`);
    fundingsContainer.innerHTML = '';

    if (!fundingsList || fundingsList.length === 0) {
        fundingsContainer.innerHTML = '<p>펀딩 목록이 없습니다.</p>';
        return;
    }

    fundingsList.forEach(funding => {
        const fundingItem = document.createElement('a');
        fundingItem.className = 'funding-item';
        fundingItem.href = `/api/fundings/${funding.categoryId}/details/${funding.fundingsId}`;

        const title = document.createElement('div');
        title.className = 'funding-title';
        title.textContent = funding.title.length > 20 ? funding.title.substring(0, 20) + '...' : funding.title;

        const details = document.createElement('div');
        details.className = 'funding-details';
        details.innerHTML = `목표 금액: ${funding.goalAmount}원<br> 좋아요 수: <span class="like-count">${funding.likeCount}</span>개
        					<br> 개설자: ${funding.nickname}`;

        const imagesContainer = document.createElement('div');
        imagesContainer.className = 'funding-images';

        if (funding.imageUrls && funding.imageUrls.length > 0) {
            funding.imageUrls.forEach((imageUrl, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = `/images/fundings/${imageUrl}`;
                if (index === 0) {
                    imgElement.classList.add('active');
                }
                imagesContainer.appendChild(imgElement);
            });

            const prevButton = document.createElement('a');
            prevButton.className = 'prev';
            prevButton.textContent = '❮';
            prevButton.onclick = function (event) {
                event.preventDefault();
                showSlides(imagesContainer, -1);
            };

            const nextButton = document.createElement('a');
            nextButton.className = 'next';
            nextButton.textContent = '❯';
            nextButton.onclick = function (event) {
                event.preventDefault();
                showSlides(imagesContainer, 1);
            };

            imagesContainer.appendChild(prevButton);
            imagesContainer.appendChild(nextButton);
        }

        const progressContainer = document.createElement('div');
        progressContainer.className = 'funding-progress';

        const progressBar = document.createElement('div');
        progressBar.className = 'funding-progress-bar';
        const progressPercent = funding.percent; // percent 값 사용
        console.log(`Funding ID: ${funding.fundingsId}, Progress: ${progressPercent}%`);
        progressBar.style.width = `${progressPercent}%`;

        const progressText = document.createElement('div');
        progressText.className = 'funding-progress-text';
        progressText.textContent = `${Math.round(progressPercent)}%`;

        progressContainer.appendChild(progressBar);
        progressContainer.appendChild(progressText);

        const likeButton = document.createElement('div');
        likeButton.className = 'like-button';
        likeButton.innerHTML = '♥';
        if (funding.existsFlag === 'Y') {
            likeButton.classList.add('liked');
        }

        likeButton.onclick = function(event) {
            event.preventDefault();
            handleLike(funding.fundingsId, likeButton, details.querySelector('.like-count'));
        };

        fundingItem.appendChild(title);
        fundingItem.appendChild(details);
        fundingItem.appendChild(imagesContainer);
        fundingItem.appendChild(progressContainer);
        fundingItem.appendChild(likeButton);
        fundingsContainer.appendChild(fundingItem);
    });
}

function showSlides(container, n) {
    const slides = container.querySelectorAll('img');
    let currentIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
    if (currentIndex === -1) return;
    slides[currentIndex].classList.remove('active');
    currentIndex = (currentIndex + n + slides.length) % slides.length;
    slides[currentIndex].classList.add('active');
}

async function handleLike(fundingsId, likeButton, likeCountElement) {
    try {
        const response = await fetch(`/api/fundings/like/${fundingsId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getJwtToken() // JWT 토큰을 포함합니다.
            }
        });

        if (response.status === 401) {
            alert('로그인이 필요합니다.');
            return;
        }

        if (response.ok) {
            const result = await response.json();
            if (result.liked) {
                likeButton.classList.add('liked');
                likeCountElement.textContent = parseInt(likeCountElement.textContent) + 1;
            } else {
                likeButton.classList.remove('liked');
                likeCountElement.textContent = parseInt(likeCountElement.textContent) - 1;
            }
        } else {
            alert('좋아요 처리 중 오류가 발생했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('좋아요 처리 중 오류가 발생했습니다.');
    }
}

function getJwtToken() {
    return localStorage.getItem('jwtToken'); // 예시: JWT 토큰을 로컬 스토리지에서 가져옵니다.
}

document.addEventListener('DOMContentLoaded', () => {
    fetchFundings('createdDate');
    fetchFundings('inProgress');
    fetchFundings('likes');
});
</script>
</head>
<body>
    <div layout:fragment="content">
        <div class="content-wrapper">
            <div class="section-container">
                <h2>새로 올라온 펀딩</h2>
                <div id="createdDateContainer" class="content-container">
                    <!-- 새로 올라온 펀딩 항목이 여기에 표시됩니다. -->
                </div>
            </div>
            <div class="section-container">
                <h2>진행중인 펀딩</h2>
                <div id="inProgressContainer" class="content-container">
                    <!-- 진행중인 펀딩 항목이 여기에 표시됩니다. -->
                </div>
            </div>
            <div class="section-container">
                <h2>좋아요순 펀딩</h2>
                <div id="likesContainer" class="content-container">
                    <!-- 좋아요순 펀딩 항목이 여기에 표시됩니다. -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
